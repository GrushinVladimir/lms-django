{% extends 'lms_cleint/base.html' %}
{% block content %}
<div class="container">
    <h2>Создание теста для главы: {{ chapter.name }}</h2>
    
    <form method="post" id="test-form">
        {% csrf_token %}
        <div class="card mb-4">
            <div class="card-body">
                <div class="mb-3">
                    {{ form.title.label_tag }}
                    {{ form.title }}
                </div>
                <div class="mb-3">
                    {{ form.description.label_tag }}
                    {{ form.description }}
                </div>
            </div>
        </div>
        
        <h3 class="mb-3">Вопросы теста</h3>
        
        {{ question_formset.management_form }}
        <div id="questions-container">
            {% for form in question_formset %}
            <div class="card mb-3 question-item">
                <div class="card-body">
                    {{ form.id }}
                    <div class="mb-3">
                        <label for="{{ form.text.id_for_label }}">Текст вопроса:</label>
                        <textarea name="{{ form.text.html_name }}" class="form-control" id="{{ form.text.id_for_label }}" rows="3" required>{{ form.text.value|default_if_none:'' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.question_type.id_for_label }}">Тип вопроса:</label>
                        <select name="{{ form.question_type.html_name }}" class="form-select" id="{{ form.question_type.id_for_label }}" onchange="toggleAnswerFields(this)">
                            <option value="">Выберите тип вопроса</option>
                            <option value="single" {% if form.question_type.value == 'single' %}selected{% endif %}>Один правильный ответ</option>
                            <option value="multiple" {% if form.question_type.value == 'multiple' %}selected{% endif %}>Несколько правильных ответов</option>
                            <option value="text" {% if form.question_type.value == 'text' %}selected{% endif %}>Текстовый ответ</option>
                        </select>
                    </div>
                    
                    <div class="answers-section mb-3" style="display: {% if form.question_type.value in 'single,multiple' %}block{% else %}none{% endif %};">
                        <h5>Варианты ответов</h5>
                        <div class="answers-list">
                            {% if form.instance.pk %}
                                {% for answer in form.instance.answers.all %}
                                <div class="answer-item mb-2 p-2 border rounded">
                                    <div class="form-group">
                                        <label>Текст ответа:</label>
                                        <input type="text" name="answer-{{ form.instance.id }}-{{ answer.id }}-text" 
                                               class="form-control" value="{{ answer.text }}" required>
                                    </div>
                                    <div class="form-check">
                                        <input type="{% if form.question_type.value == 'single' %}radio{% else %}checkbox{% endif %}" 
                                               name="answer-{{ form.instance.id }}-correct" 
                                               value="{{ answer.id }}" 
                                               class="form-check-input"
                                               {% if answer.is_correct %}checked{% endif %}>
                                        <label class="form-check-label">Правильный ответ</label>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-danger remove-answer">Удалить</button>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-sm btn-success add-answer" style="display: {% if form.question_type.value in 'single,multiple' %}block{% else %}none{% endif %};">Добавить вариант</button>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-sm btn-primary save-question">Сохранить вопрос</button>
                        <button type="button" class="btn btn-sm btn-danger remove-question">Удалить вопрос</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <button type="button" id="add-question" class="btn btn-success">Добавить вопрос</button>
            <div>
                <button type="submit" class="btn btn-primary me-2">Сохранить тест</button>
                <a href="{% url 'chapter_detail' chapter.id %}" class="btn btn-secondary">Отмена</a>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для переключения отображения поля ответов
    function toggleAnswerFields(selectElement) {
        const answersSection = selectElement.closest('.question-item').querySelector('.answers-section');
        const addAnswerBtn = selectElement.closest('.question-item').querySelector('.add-answer');
        
        if (selectElement.value === 'text') {
            answersSection.style.display = 'none';
            addAnswerBtn.style.display = 'none';
        } else {
            answersSection.style.display = 'block';
            addAnswerBtn.style.display = 'block';
        }
    }
    
    // Инициализация при загрузке
    document.querySelectorAll('select[id^="id_questions-"][id$="-question_type"]').forEach(select => {
        toggleAnswerFields(select);
    });
    
    // Добавление нового вопроса
    document.querySelector('#add-question').addEventListener('click', function() {
        const formCount = parseInt(document.querySelector('#id_questions-TOTAL_FORMS').value);
        const container = document.querySelector('#questions-container');
        const newFormNum = formCount;
        
        // Увеличиваем счетчик форм
        document.querySelector('#id_questions-TOTAL_FORMS').value = formCount + 1;
        
        // Создаем новую форму вопроса
        const newQuestion = document.createElement('div');
        newQuestion.className = 'card mb-3 question-item';
        newQuestion.innerHTML = `
            <div class="card-body">
                <input type="hidden" name="questions-${newFormNum}-id" id="id_questions-${newFormNum}-id">
                <div class="mb-3">
                    <label for="id_questions-${newFormNum}-text">Текст вопроса:</label>
                    <textarea name="questions-${newFormNum}-text" class="form-control" id="id_questions-${newFormNum}-text" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="id_questions-${newFormNum}-question_type">Тип вопроса:</label>
                    <select name="questions-${newFormNum}-question_type" class="form-select" id="id_questions-${newFormNum}-question_type" onchange="toggleAnswerFields(this)">
                        <option value="">Выберите тип вопроса</option>
                        <option value="single">Один правильный ответ</option>
                        <option value="multiple">Несколько правильных ответов</option>
                        <option value="text">Текстовый ответ</option>
                    </select>
                </div>
                <div class="answers-section mb-3" style="display: none;">
                    <h5>Варианты ответов</h5>
                    <div class="answers-list"></div>
                    <button type="button" class="btn btn-sm btn-success add-answer" style="display: none;">Добавить вариант</button>
                </div>
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-sm btn-primary save-question">Сохранить вопрос</button>
                    <button type="button" class="btn btn-sm btn-danger remove-question">Удалить вопрос</button>
                </div>
            </div>
        `;
        
        container.appendChild(newQuestion);
        
        // Обработчик удаления вопроса
        newQuestion.querySelector('.remove-question').addEventListener('click', function() {
            container.removeChild(newQuestion);
        });
        
        // Обработчик сохранения вопроса
        newQuestion.querySelector('.save-question').addEventListener('click', function() {
            // Здесь можно добавить AJAX-запрос для сохранения вопроса
            alert('Вопрос сохранен!');
        });
        
        // Обработчик изменения типа вопроса
        newQuestion.querySelector('select').addEventListener('change', function() {
            toggleAnswerFields(this);
        });
    });
    
    // Обработчики сохранения вопросов для существующих вопросов
    document.querySelectorAll('.save-question').forEach(btn => {
        btn.addEventListener('click', function() {
            // Здесь можно добавить AJAX-запрос для сохранения вопроса
            alert('Вопрос сохранен!');
        });
    });
    
    // Глобальная функция для переключения полей ответов
    window.toggleAnswerFields = function(selectElement) {
        const answersSection = selectElement.closest('.question-item').querySelector('.answers-section');
        const addAnswerBtn = selectElement.closest('.question-item').querySelector('.add-answer');
        
        if (!selectElement.value || selectElement.value === 'text') {
            answersSection.style.display = 'none';
            addAnswerBtn.style.display = 'none';
        } else {
            answersSection.style.display = 'block';
            addAnswerBtn.style.display = 'block';
            
            // Добавляем обработчик для кнопки добавления ответа
            addAnswerBtn.onclick = function() {
                const answersList = this.previousElementSibling;
                const answerCount = answersList.children.length;
                
                const newAnswer = document.createElement('div');
                newAnswer.className = 'answer-item mb-2 p-2 border rounded';
                newAnswer.innerHTML = `
                    <div class="form-group">
                        <label>Текст ответа:</label>
                        <input type="text" name="answers-${selectElement.id.split('-')[1]}-${answerCount}-text" class="form-control" required>
                    </div>
                    <div class="form-check">
                        <input type="${selectElement.value === 'single' ? 'radio' : 'checkbox'}" 
                               name="answers-${selectElement.id.split('-')[1]}-correct" 
                               value="${answerCount}" 
                               class="form-check-input">
                        <label class="form-check-label">Правильный ответ</label>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-answer">Удалить</button>
                `;
                
                answersList.appendChild(newAnswer);
                
                // Обработчик удаления ответа
                newAnswer.querySelector('.remove-answer').addEventListener('click', function() {
                    answersList.removeChild(newAnswer);
                });
            };
        }
    };
});
</script>

<style>
.question-item {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 15px;
}
.answer-item {
    background-color: #e9ecef;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
}
.remove-question {
    margin-top: 10px;
}
.add-answer {
    margin-top: 10px;
}
</style>
{% endblock %}