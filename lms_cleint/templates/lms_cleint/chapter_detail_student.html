{% extends 'lms_cleint/base.html' %}
{% load static %}
{% block extra_css %}
<style>
    .progress-bar {
        transition: width 0.5s ease-in-out;
    }
    .list-group-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .material-content {
        display: flex;
        justify-content: space-between;
        width: 100%;
    }
    .material-actions {
        display: flex;
        align-items: center;
    }
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1100;
    }
    .material-badge {
        margin-left: 10px;
    }
    .answer-section {
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    .video-modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .video-modal-content {
        background-color: #fefefe;
        margin: 9% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    /* Стили для уведомлений */
    .notification-badge {
        position: relative;
        display: inline-block;
        margin-right: 10px;
    }
    .notification-dot {
   
    }
    .grade-modal-content {
        padding: 20px;
    }
    .grade-badge {
        font-size: 1.1em;
        padding: 5px 10px;
    }

.notification-dot.notification-seen + svg.bell {
  fill: #a0a0a0 !important;
  animation: none;
  transform: rotate(15deg);
}
.bell {
  transform: rotate(15deg); /* Изначальный наклон */
  z-index: 2;
  fill: #76bdad; /* Исходный цвет (зелёный/бирюзовый) */
  position: relative;
  transform-origin: 50% 0;
  animation: ring 3s infinite ease-in-out;
  transition: fill 0.3s ease; /* Плавное изменение цвета */
}

.notification-seen .bell {
  fill: #a0a0a0 !important; /* Серый цвет при просмотре */
  animation: none; /* Останавливаем анимацию */
  transform: rotate(15deg); /* Фиксируем положение */
}

@keyframes ring {
  0%, 40%, 100% {
    transform: rotate(15deg);
  }
  10% {
    transform: rotate(35deg);
  }
  20% {
    transform: rotate(-5deg);
  }
  30% {
    transform: rotate(35deg);
  }
}
</style>
{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <!-- Прогресс бар -->
            <div class="progress mb-3">
                <div id="progress-bar" class="progress-bar" role="progressbar"
                     style="width: {{ progress|default:0 }}%;"
                     aria-valuenow="{{ progress|default:0 }}"
                     aria-valuemin="0" aria-valuemax="100">
                    {{ progress|default:0 }}%
                </div>
            </div>
        </div>
    </div>
    <h3 class="mt-4">Материалы главы</h3>
    <ul id="materials-list" class="list-group" data-chapter-id="{{ chapter.id }}">
        
        {% for material in materials %}
        
        <li class="list-group-item mb-3" data-id="{{ material.material_type }}_{{ material.id }}" data-type="{{ material.material_type }}">
<!-- Иконка уведомления об оценке -->
{% if material.material_type == 'file' and material.user_answer and material.user_answer.grade %}
<a href="#"  class="notification-badge" data-bs-toggle="modal" data-answer-id="{{ material.user_answer.id }}">
      {% if material.user_answer.is_new %}
<svg class="bell" width="24" height="24" id="Ecommerce" enable-background="new 0 0 48 48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><g>
    <path d="m35.811 33.617c-8.25 1.589-16.194 1.628-23.612.122-.542-.103-1.069.241-1.179.781-.11.541.24 1.069.781 1.18 3.744.76 7.612 1.14 11.581 1.14 4.169 0 8.449-.42 12.807-1.258.542-.104.897-.629.793-1.172-.104-.542-.622-.89-1.171-.793z"/><path d="m15.957 18.251c.065.013.13.019.194.019.468 0 .886-.33.98-.807.441-2.242 2.151-3.888 5.082-4.893.434-.108.753-.502.753-.971 0-.662-.7-1.161-1.325-.947-4.61 1.556-6.063 4.352-6.471 6.424-.108.542.245 1.069.787 1.175z"/><path d="m37 19c0-.576-.033-1.142-.097-1.683-.804-6.812-6.411-9.56-9.682-10.591-.181-.057-.366-.103-.552-.15.205-.405.331-.856.331-1.34 0-1.654-1.346-3-3-3s-3 1.346-3 3c0 .484.126.935.33 1.34-.186.047-.373.094-.555.151-.62.198-1.172.402-1.685.621-3.349 1.42-5.704 3.557-6.999 6.354-.724 1.576-1.091 3.359-1.091 5.298 0 10.037-4.529 13.638-4.569 13.669-.253.189-.401.485-.401.801v4.759c-.008.434.264.824.675.966 3.991 1.37 8.161 2.22 12.399 2.571.458 2.286 2.486 4.025 4.896 4.025 2.435 0 4.467-1.763 4.905-4.079 3.997-.365 8.139-1.129 12.336-2.307.432-.121.73-.515.73-.963v-4.972c0-.311-.149-.607-.396-.797-.046-.035-4.575-3.636-4.575-13.673zm-13-14.764c.551 0 1 .448 1 1s-.449 1-1 1-1-.448-1-1 .449-1 1-1zm0 39.554c-1.25 0-2.327-.781-2.775-1.877.768.033 1.543.055 2.333.055 1.057 0 2.139-.04 3.23-.098-.437 1.12-1.52 1.92-2.788 1.92zm15.97-6.111c-4.109 1.108-8.159 1.823-12.044 2.124-2.728.202-5.37.221-7.859.049-4.111-.273-8.156-1.054-12.037-2.323v-3.604c1.254-1.182 4.97-5.479 4.97-14.925 0-1.648.306-3.15.908-4.46 1.079-2.33 3.084-4.13 5.965-5.351.458-.196.952-.378 1.508-.557 1.652-.521 3.584-.522 5.238.001 3.434 1.083 7.66 3.509 8.298 8.919v.001c.055.464.083.95.083 1.447 0 9.446 3.716 13.743 4.97 14.925z"/></g></svg>
    <span class="notification-dot {% if not material.user_answer.is_new %}notification-seen{% endif %}"> </span>
      {% else %}
    <svg class="checkmark" width="24" height="24" viewBox="0 0 456.556 456.556">
      <path fill="#28a745" d="M228.278,456.556C102.403,456.556,0,354.153,0,228.278S102.403,0,228.278,0c42.641,0,84.233,11.834,120.287,34.228 c6.301,3.91,8.232,12.19,4.322,18.492c-3.917,6.301-12.197,8.246-18.492,4.322c-31.794-19.751-68.49-30.185-106.117-30.185 c-111.065,0-201.422,90.36-201.422,201.422S117.213,429.7,228.278,429.7c111.062,0,201.422-90.36,201.422-201.422 c0-22.324-3.623-44.243-10.77-65.147c-2.399-7.015,1.35-14.652,8.365-17.051c7.029-2.385,14.652,1.35,17.051,8.365 c8.099,23.709,12.211,48.551,12.211,73.834C456.556,354.153,354.153,456.556,228.278,456.556z"/>
      <path fill="#28a745" d="M228.278,305.727c-3.406,0-6.7-1.294-9.193-3.644L111.66,201.17c-5.406-5.077-5.672-13.575-0.594-18.981 c5.078-5.399,13.575-5.679,18.981-0.587l97.092,91.206L403.564,63.371c4.77-5.672,13.246-6.399,18.918-1.616 c5.672,4.777,6.399,13.246,1.616,18.918L238.545,300.951c-2.371,2.818-5.805,4.539-9.484,4.756 C228.803,305.72,228.537,305.727,228.278,305.727z"/>
    </svg>
  {% endif %}
</a>
  {% endif %}
            <div class="material-content">
                
                <!-- Кнопка выполнения и название материала -->
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm
                        {% if material.user_completed %}
                            btn-success disabled
                        {% else %}
                            btn-outline-secondary {% if material.material_type == 'test' %}disabled{% endif %}
                        {% endif %}
                        complete-btn"
                        data-id="{{ material.id }}"
                        data-type="{{ material.material_type }}"
                        {% if material.material_type == 'test' or material.user_completed %}disabled{% endif %}>
                        {% if material.user_completed %}Выполнено{% else %}Выполнить{% endif %}
                    </button>
                    <div class="ms-3">

                        
                        <!-- Иконка в зависимости от типа материала -->
                        {% if material.material_type == 'file' %}
                            <i class="fas fa-file me-2"></i>
                        {% elif material.material_type == 'article' %}
                            <i class="fas fa-newspaper me-2"></i>
                        {% elif material.material_type == 'test' %}
                            <i class="fas fa-question-circle me-2"></i>
                        {% elif material.material_type == 'video' %}
                            <i class="fas fa-video me-2"></i>
                        {% elif material.material_type == 'link' %}
                            <i class="fas fa-link me-2"></i>
                        {% endif %}
                        <strong>
                            {% if material.material_type == 'file' %}
                                <a href="{{ material.file.url }}" target="_blank">
                                    {{ material.display_name|default:material.file.name }}
                                </a> 
                            {% elif material.material_type == 'article' %}
                          
                                <a href="{% url 'article_detail' material.id %}" target="_blank">{{ material.title }}</a>
                                
                            {% elif material.material_type == 'test' %}
                                <a href="{% url 'view_test' material.id %}">
                                    {{ material.title }}
                                </a>                                           
                            {% elif material.material_type == 'video' %}
                <a href="javascript:void(0)" onclick="openVideoModal('{{ material.video_url }}')">Воспроизвести</button>
                                {{ material.title }}
                </a> 
                            {% elif material.material_type == 'link' %}
                                <a href="{{ material.url }}" target="_blank">{{ material.title }}</a>
                            {% endif %}
                        </strong>
                        <span class="badge
                            {% if material.material_type == 'file' %}bg-success
                            {% elif material.material_type == 'article' %}bg-success
                            {% elif material.material_type == 'test' %}bg-success
                            {% elif material.material_type == 'video' %}bg-success
                            {% elif material.material_type == 'link' %}bg-success{% endif %}">
                            {% if material.material_type == 'file' %}
                                {% if material.is_pdf %}PDF
                                {% elif material.is_word %}Word
                                {% elif material.is_ppt %}PowerPoint
                                {% else %}Файл{% endif %}
                            {% elif material.material_type == 'article' %}
                                Статья
                            {% elif material.material_type == 'test' %}
                                Тест
                            {% elif material.material_type == 'video' %}
                                Видео
                            {% elif material.material_type == 'link' %}
                                Ссылка
                            {% endif %}
                        </span>
                    </div>
                </div>
                <!-- Содержимое материала -->
                <div class="material-actions">
                    {% if material.material_type == 'file' %}
                        {% if material.provide_answer %}
                            {% if material.user_answer %}     
                                <small>Загруженный ответ:<br>
                                    <a href="{{ material.user_answer.file.url }}" target="_blank">
                                        {{ material.user_answer.file.name|slice:"20" }}{% if material.user_answer.file.name|length > 20 %}...{% endif %}
                                    </a>
                                </small>
                            {% endif %}
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" 
                                    data-bs-target="#addAnswerModal" 
                                    data-file-id="{{ material.id }}">
                                <i class="fas fa-upload"></i> Добавить ответ
                            </button>
                        {% endif %}
                    {% elif material.material_type == 'test' %}
                        <div class="btn-group"></div>
                    {% endif %}
                </div>
            </div>
        </li>
        {% empty %}
        <li class="list-group-item">Материалы пока не добавлены</li>
        {% endfor %}
    </ul>
    <div class="mt-4">
        <a href="{% url 'course_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Вернуться к курсам
        </a>
    </div>
</div>

<!-- Модальное окно уведомления об оценке -->
<div class="modal fade" id="gradeNotificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ваша оценка</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body grade-modal-content" id="gradeModalContent">
                <!-- Содержимое будет загружено динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ОК</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения выполнения -->
<div class="modal fade" id="confirmCompletionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Вы уверены, что хотите отметить этот материал как выполненный?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="confirmCompletionBtn">Подтвердить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра видео -->
<div id="videoModal" class="video-modal">
    <div class="video-modal-content">
        <span class="close" onclick="closeVideoModal()">&times;</span>
        <div id="videoContainer"></div>
    </div>
</div>
{% include 'lms_cleint/modals/add_answer.html' %}

{% endblock %}
{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Проверяем, есть ли answer_id в URL
    const urlParams = new URLSearchParams(window.location.search);
    const answerId = urlParams.get('answer_id');
    
    if (answerId) {
        // Находим соответствующий элемент уведомления
        const notificationBadge = document.querySelector(`.notification-badge[data-answer-id="${answerId}"]`);
        
        if (notificationBadge) {
            // Имитируем клик по элементу уведомления
            notificationBadge.click();
            
            // Удаляем answer_id из URL без перезагрузки страницы
            const newUrl = window.location.pathname + window.location.search.replace(/answer_id=[^&]*&?/, '').replace(/&$/, '').replace(/\?$/, '');
            window.history.replaceState({}, document.title, newUrl);
        }
    }
});



document.addEventListener('DOMContentLoaded', function() {
    // Обработчик модального окна
    const answerModal = document.getElementById('addAnswerModal');
    if (answerModal) {
        answerModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const fileId = button.getAttribute('data-file-id');
            document.getElementById('fileId').value = fileId;
        });
        
        // Обработчик отправки формы
        const answerForm = document.getElementById('answerUploadForm');
        if (answerForm) {
            answerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const form = this;
                const formData = new FormData(form);
                const submitBtn = form.querySelector('button[type="submit"]');
                
                // Блокируем кнопку на время отправки
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Отправка...';

                fetch('/upload_answer/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'  // Добавляем этот заголовок
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        showToast('Ответ успешно загружен');
                        bootstrap.Modal.getInstance(answerModal).hide();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        throw new Error(data.message || 'Неизвестная ошибка');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Ошибка: ' + (error.message || 'При загрузке ответа'), 'danger');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Отправить';
                });
            });
        }
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function updateNotificationsList() {
    fetch('{% url "notifications" %}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newContent = doc.querySelector('.list-group').innerHTML;
        document.querySelector('.list-group').innerHTML = newContent;
    })
    .catch(error => console.error('Error updating notifications:', error));
}
document.querySelectorAll('.notification-badge').forEach(icon => {
    icon.addEventListener('click', async function(e) {
        e.preventDefault();
        const answerId = this.getAttribute('data-answer-id');
        const notificationDot = this.querySelector('.notification-dot');
        const bellIcon = this.querySelector('.bell');
        
        // 1. Safely initialize modal
        const modalElement = document.getElementById('gradeNotificationModal');
        if (!modalElement) {
            console.error('Modal element not found');
            return;
        }
        
        let modal;
        try {
            modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
        } catch (error) {
            console.error('Error initializing modal:', error);
            return;
        }
        
        try {
            // 2. Загрузка данных оценки
            const gradeResponse = await fetch(`/get_grade_details/${answerId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (!gradeResponse.ok) throw new Error('Ошибка загрузки оценки');
            
            const gradeData = await gradeResponse.json();
            if (gradeData.status !== 'success') throw new Error(gradeData.message || 'Ошибка данных оценки');
            
            // 3. Заполнение модального окна
            const modalBody = document.getElementById('gradeModalContent');
            modalBody.innerHTML = `
                <div class="mb-3">
                    <h6>Оценка: 
                        <span class="badge grade-badge bg-${gradeData.grade >= 5 ? 'success' : 'warning'}">
                            ${gradeData.grade}
                        </span>
                    </h6>
                </div>
                ${gradeData.feedback ? `
                <div class="mb-3">
                    <h6>Комментарий:</h6>
                    <p>${gradeData.feedback}</p>
                </div>
                ` : ''}
                ${gradeData.graded_by ? `
                <div class="mb-3">
                    <h6>Преподаватель:</h6>
                    <p>${gradeData.graded_by}</p>
                </div>
                ` : ''}
                <div class="mb-3">
                    <small class="text-muted">
                        ${gradeData.graded_at ? `Дата оценки: ${gradeData.graded_at}` : ''}
                    </small>
                </div>
            `;
            
            // 4. Показ модального окна
            modal.show();
            
            // 5. Пометить оценку как прочитанную
            const markReadResponse = await fetch(`/mark_grade_as_read/${answerId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!markReadResponse.ok) throw new Error('Ошибка отметки прочтения оценки');
            
// 6. Пометить уведомления как прочитанные
const markNotificationResponse = await fetch('{% url "mark_grade_notification_as_read" %}', {
    method: 'POST',
    headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({ answer_id: answerId })
});

if (!markNotificationResponse.ok) {
    const errorData = await markNotificationResponse.json().catch(() => ({}));
    throw new Error(errorData.message || 'Ошибка отметки уведомления');
}

const result = await markNotificationResponse.json();
if (result.status !== 'success') {
    throw new Error(result.message || 'Не удалось обновить уведомления');
}

// 7. Обновить UI
if (notificationDot) notificationDot.classList.add('notification-seen');
if (bellIcon) {
    bellIcon.outerHTML = `
        <svg class="checkmark" width="24" height="24" viewBox="0 0 456.556 456.556">
            <path fill="#28a745" d="M228.278,456.556C102.403,456.556,0,354.153,0,228.278S102.403,0,228.278,0c42.641,0,84.233,11.834,120.287,34.228 c6.301,3.91,8.232,12.19,4.322,18.492c-3.917,6.301-12.197,8.246-18.492,4.322c-31.794-19.751-68.49-30.185-106.117-30.185 c-111.065,0-201.422,90.36-201.422,201.422S117.213,429.7,228.278,429.7c111.062,0,201.422-90.36,201.422-201.422 c0-22.324-3.623-44.243-10.77-65.147c-2.399-7.015,1.35-14.652,8.365-17.051c7.029-2.385,14.652,1.35,17.051,8.365 c8.099,23.709,12.211,48.551,12.211,73.834C456.556,354.153,354.153,456.556,228.278,456.556z"/>
            <path fill="#28a745" d="M228.278,305.727c-3.406,0-6.7-1.294-9.193-3.644L111.66,201.17c-5.406-5.077-5.672-13.575-0.594-18.981 c5.078-5.399,13.575-5.679,18.981-0.587l97.092,91.206L403.564,63.371c4.77-5.672,13.246-6.399,18.918-1.616 c5.672,4.777,6.399,13.246,1.616,18.918L238.545,300.951c-2.371,2.818-5.805,4.539-9.484,4.756 C228.803,305.72,228.537,305.727,228.278,305.727z"/>
        </svg>`;
}

// Обновляем список уведомлений, если функция существует
if (typeof updateNotificationsList === 'function') {
    updateNotificationsList();
}
        } catch (error) {
            console.error('Error:', error);
            showToast('Ошибка: ' + error.message, 'danger');
        }
    });
});


    // Глобальные переменные
    let currentMaterialToComplete = null;

    // Функции для работы с видео
    function openVideoModal(videoUrl) {
        const modal = document.getElementById('videoModal');
        const videoContainer = document.getElementById('videoContainer');
        if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
            let videoId = videoUrl.split('v=')[1];
            if (!videoId) videoId = videoUrl.split('youtu.be/')[1];
            if (videoId) videoId = videoId.split('&')[0];
            videoContainer.innerHTML = `
                <iframe width="100%" height="700"
                    src="https://www.youtube.com/embed/${videoId}"
                    frameborder="0"
                    allowfullscreen>
                </iframe>`;
        } else {
            videoContainer.innerHTML = `
                <video width="100%" height="700" controls>
                    <source src="${videoUrl}" type="video/mp4">
                    Ваш браузер не поддерживает видео.
                </video>`;
        }
        modal.style.display = "block";
    }

    function closeVideoModal() {
        document.getElementById('videoModal').style.display = "none";
        document.getElementById('videoContainer').innerHTML = '';
    }

    // Функция для получения CSRF-токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Функция для показа уведомлений
    function showToast(message, type = 'success') {
        const toastContainer = document.querySelector('.toast-container') || (() => {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        })();
        const toastId = 'toast-' + Date.now();
        toastContainer.insertAdjacentHTML('beforeend', `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `);
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();
        // Автоматическое удаление через 5 секунд
        setTimeout(() => toast.dispose(), 5000);
    }

    // Функция для обновления прогресса главы
    function updateChapterProgress() {
        const chapterId = document.getElementById('materials-list')?.dataset.chapterId;
        if (!chapterId) return;
        fetch(`/get_progress/?chapter_id=${chapterId}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                animateProgressBar(data.progress);
            }
        })
        .catch(error => console.error('Ошибка обновления прогресса:', error));
    }

    // Инициализация сортировки
    function initSortable(chapterId) {
        const materialsList = document.getElementById('materials-list');
        if (materialsList) {
            new Sortable(materialsList, {
                animation:35,
                ghostClass: 'sortable-ghost',
                handle: '.drag-handle',
                onEnd: function() {
                    const order = Array.from(materialsList.children).map(item => item.dataset.id);
                    saveMaterialsOrder(chapterId, order);
                }
            });
        }
    }

    // Сохранение порядка материалов
    function saveMaterialsOrder(chapterId, order) {
        fetch(`/chapter/${chapterId}/update_materials_order/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({order: order})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast('Порядок материалов сохранён');
            } else {
                showToast('Ошибка при сохранении порядка', 'danger');
            }
        })
        .catch(error => {
            showToast('Ошибка при сохранении порядка', 'danger');
            console.error('Ошибка:', error);
        });
    }

    // Функция для подтверждения выполнения материала
    function confirmMaterialCompletion() {
        if (!currentMaterialToComplete) return;
        const { id, type, element } = currentMaterialToComplete;
        const url = `/complete_material/${type}/${id}/`;
        // Блокируем кнопку на время выполнения запроса
        element.disabled = true;
        element.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Обработка...';
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Ошибка сервера: ${response.status} - ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // Обновляем кнопку
                element.classList.remove('btn-outline-secondary');
                element.classList.add('btn-success');
                element.textContent = 'Выполнено';
                // Обновляем прогресс
                updateChapterProgress();
                // Закрываем модальное окно
                bootstrap.Modal.getInstance(document.getElementById('confirmCompletionModal')).hide();
                showToast('Материал отмечен как выполненный');
            } else {
                throw new Error(data.message || 'Неизвестная ошибка');
            }
        })
        .catch(error => {
            // Восстанавливаем кнопку при ошибке
            element.disabled = false;
            element.textContent = element.textContent.includes('Выполнено') ? 'Выполнено' : 'Выполнить';
            showToast(`Ошибка: ${error.message}`, 'danger');
            console.error('Ошибка:', error);
        });
    }

    // Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Проверяем параметр answer_id в URL
    const urlParams = new URLSearchParams(window.location.search);
    const answerId = urlParams.get('answer_id');
    
    if (answerId) {
        // Если есть answer_id - загружаем данные оценки
        fetchGradeDetails(answerId);
        
        // Помечаем уведомление как прочитанное
        fetch(`/mark_grade_notification_as_read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ answer_id: answerId })
        });
        
        // Убираем answer_id из URL без перезагрузки
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
});

    // Анимация прогресс-бара
    function animateProgressBar(targetProgress) {
        const progressBar = document.getElementById('progress-bar');
        const currentWidth = parseFloat(progressBar.style.width) || 0;
        const duration = 500; // milliseconds
        const startTime = performance.now();
        // Убедимся, что targetProgress - число
        targetProgress = parseFloat(targetProgress) || 0;
        function updateProgress(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const currentProgress = currentWidth + (targetProgress - currentWidth) * progress;
            // Обновляем прогресс-бар
            progressBar.style.width = `${currentProgress}%`;
            progressBar.setAttribute('aria-valuenow', Math.round(currentProgress));
            progressBar.textContent = `${Math.round(currentProgress)}%`;
            if (progress < 1) {
                requestAnimationFrame(updateProgress);
            }
        }
        requestAnimationFrame(updateProgress);
    }
</script>
{% endblock %}