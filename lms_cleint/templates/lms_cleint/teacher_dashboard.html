{% extends 'lms_cleint/base.html' %}
{% block content %}

<div class="container mt-4">
    <h2>Дашборд преподавателя</h2>

    <!-- Выбор группы -->
    <form method="get" class="mb-4">
        <div class="row g-3 align-items-center">
            <div class="col-auto">
                <label for="group_id" class="col-form-label">Выберите группу:</label>
            </div>
            <div class="col-auto">
                <select name="group_id" id="group_id" class="form-select" onchange="this.form.submit()">
                    <option value="">Все группы</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}" {% if group.id == selected_group.id %}selected{% endif %}>{{ group.group_number }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>

    <!-- Вкладки для переключения между тестами и файлами -->
    <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests" type="button" role="tab">Тесты</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">Файлы ответов</button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        <!-- Вкладка с тестами -->
        <div class="tab-pane fade show active" id="tests" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Выберите тест для анализа</h4>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-8">
                            <select name="test_id" class="form-select" onchange="this.form.submit()">
                                <option value="">Выберите тест</option>
                                {% for test in tests %}
                                <option value="{{ test.id }}" {% if test.id == selected_test.id %}selected{% endif %}>
                                    {{ test.title }} ({{ test.chapter.subject.name }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">Анализировать</button>
                        </div>
                    </form>
                </div>
            </div>

            {% if selected_test %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Анализ теста: {{ selected_test.title }}</h4>
                </div>
                <div class="card-body">
                    <p>Средний балл: {{ avg_score }}</p>
                    <p>Процент сдавших: {{ pass_rate }}%</p>
                    <p>Количество попыток: {{ attempt_count }}</p>

                    <h5>Статистика по вопросам</h5>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Вопрос</th>
                                <th>Процент правильных ответов</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for question_stat in question_stats %}
                            <tr>
                                <td>{{ question_stat.question.text }}</td>
                                <td>{{ question_stat.correct_rate }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Вкладка с файлами ответов -->
        <div class="tab-pane fade" id="files" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h4>Файлы ответов студентов</h4>
                </div>
                <div class="card-body">
                    {% if files_with_answers %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Файл</th>
                                    <th>Глава</th>
                                    <th>Ответ студента</th>
                                    <th>Оценка</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in files_with_answers %}
                                    {% for answer in file.file_answers.all %}
                                    <tr>
                                        <td>{{ file.display_name }}</td>
                                        <td>{{ file.chapter.name }}</td>
                                        <td>
                                            <a href="{{ answer.file.url }}" target="_blank">
                                                {{ answer.file.name|slice:"20:" }}
                                            </a>
                                        </td>
                                        <td>
                                            {% if answer.grade is not None %}
                                                {{ answer.grade }} из 10
                                            {% else %}
                                                <span class="text-muted">Не оценено</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-primary grade-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#gradeModal"
                                                    data-answer-id="{{ answer.id }}"
                                                    data-current-grade="{{ answer.grade|default:'' }}"
                                                    data-current-feedback="{{ answer.feedback|default:'' }}">
                                                {% if answer.grade is not None %}Изменить оценку{% else %}Оценить{% endif %}
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">Нет файлов с ответами для оценки</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для оценки -->
<div class="modal fade" id="gradeModal" tabindex="-1" aria-labelledby="gradeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gradeModalLabel">Оценить ответ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="gradeForm" method="post" action="{% url 'grade_file_answer' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="answer_id" id="answerIdInput">
                    <div class="mb-3">
                        <label for="gradeInput" class="form-label">Оценка (0-10)</label>
                        <input type="number" class="form-control" id="gradeInput" name="grade" min="0" max="10" required>
                    </div>
                    <div class="mb-3">
                        <label for="feedbackInput" class="form-label">Комментарий</label>
                        <textarea class="form-control" id="feedbackInput" name="feedback" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="submit" class="btn btn-primary">Сохранить оценку</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработка клика по кнопке оценки
    document.querySelectorAll('.grade-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const answerId = this.getAttribute('data-answer-id');
            const currentGrade = this.getAttribute('data-current-grade');
            const currentFeedback = this.getAttribute('data-current-feedback');

            document.getElementById('answerIdInput').value = answerId;
            document.getElementById('gradeInput').value = currentGrade;
            document.getElementById('feedbackInput').value = currentFeedback;
        });
    });

    // Обработка формы оценки
    document.getElementById('gradeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload(); // Обновляем страницу после успешной оценки
            } else {
                alert('Ошибка при сохранении оценки: ' + data.message);
            }
        })
        .catch(error => {
            alert('Произошла ошибка: ' + error.message);
        });
    });
});
</script>
{% endblock %}
