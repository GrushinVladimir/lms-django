<!DOCTYPE html>
{% load static %}
{% load breadcrumbs %}
{% load notification_tags %}

<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Cистема управления обучением{% endblock %}</title>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
      <link href="{% static 'css/base.css' %}" rel="stylesheet"> 
        <!--Наследование CSS с шаблонов-->
        {% block extra_css %}{% endblock %}
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Select2 для красивого выбора элементов -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">

</head>
    <!--Прелодер в виде белого фона-->
    <div class="preloader">
        <div class="loader"></div>
    </div>

<body style="background: none;">
    <div class="background-block"></div>
    <div class="container-fluid content p-0 m-0">
       
        <div class="col-md-10  h-100 m-auto block-mobile" style="min-height: 92vh;padding-bottom:110px;">
        <!--Уведомления-->
            <div class="position-fixed top-0 p-3" style="z-index: 11; right: 0px; width: 400px;" >
            <div class="toast-container">
                {% for message in messages %}
                <div class="toast align-items-center text-white bg-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} border-0" role="alert" aria-live="assertive" aria-atomic="true">

                </div>
                {% endfor %}
            </div>
            </div>
        <!-- Навигационная панель -->
            <ul class="me-auto navy col-md-10">
                <div>
                            <!--Логотип проекта-->
                            <a href="/">
                            <svg  class="logo"width="60" height="60" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="165" cy="80" r="22" fill="#5a9c8f" opacity="0.9"/>
                                <circle cx="147" cy="50" r="22" fill="#5a9c8f" opacity="0.9"/>
                                <circle cx="117" cy="34" r="22" fill="#5a9c8f" opacity="0.9"/>
                                <circle cx="90" cy="110" r="90" fill="#76bdad" filter="url(#shadow)"/>
                                <defs>
                                    <filter id="shadow" x="-10%" y="-10%" width="120%" height="120%">
                                        <feDropShadow dx="3" dy="3" stdDeviation="5" flood-opacity="0.2"/>
                                    </filter>
                                </defs>
                                <path d="M100 40a60 60 0 1 1 0 120 60 60 0 0 1 0-120zm0 20a40 40 0 1 0 0 80 40 40 0 0 0 0-80z" 
                                    fill="white" stroke="#fff" stroke-width="2"/>
                                <path d="M140 100a40 40 0 0 0-40-40v20a20 20 0 0 1 20 20h20z" 
                                    fill="white" stroke="#fff" stroke-width="2"/>
                            </svg>
                            </a>
                            <h2 class="name"><span>Учреждение образования</span><br>«Полное название учреждения длинное»</h2>
                            </div>

                {% if user.is_authenticated %}
                    <div>

        
                        <div class="user-dropdown">
                            {% if user.is_authenticated %}
                                <button class="dropdown-toggle" type="button" id="userMenu">
                                    <div class="avca-mini">
                                        {% if user.studentprofile %}
                                            {% with student=user.studentprofile %}
                                                {% if student.avatar %}
                                                    <img src="{{ student.avatar.url }}" alt="Avatar" class="avatar-img">
                                                {% else %}
                                                    <div class="avatar-pla">
                                                        {{ student.last_name|first }}{{ student.first_name|first }}
                                                    </div>
                                                {% endif %}
                                            {% endwith %}
                                        {% elif user.teacherprofile %}
                                            {% with teacher=user.teacherprofile %}
                                                {% if teacher.avatar %}
                                                    <img src="{{ teacher.avatar.url }}" alt="Avatar" class="avatar-img">
                                                {% else %}
                                                    <div class="avatar-pla">
                                                        {{ teacher.last_name|first }}{{ teacher.first_name|first }}
                                                    </div>
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    </div>
                                </button>
                                <div class="dropdown-menu">
                                    {% if user.studentprofile %}
                                        <a class="" href="{% url 'student_profile' user.studentprofile.id %}">Профиль</a>
                                    {% elif user.teacherprofile %}
                                        <a class="" href="{% url 'teacher_profile' user.teacherprofile.id %}">Профиль</a>
                                    {% endif %}
                                    <a class="" href="{% url 'logout' %}">Выйти</a>
                                </div>
                            {% endif %}
                        </div>
            </div>
                {% else %}
                {% endif %}
            </ul>  
        <!--Иконки уведомлений-->
            <div class="box-uv"> 
<a href="{% url 'notifications' %}" id="notification-bell">
    <div style="position: relative; display: inline-block;">
        {% unread_notifications_count request.user as unread_count %}
        {% if unread_count > 0 %}
            <span class="schet" id="notification-counter">{{ unread_count }}</span>  
        {% endif %}
        <svg class="uv-tick" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612.281 612.281" style="enable-background:new 0 0 612.281 612.281;" xml:space="preserve"><g><g id="_x37__29_"><g><path d="M510.533,26.617C413.372-28.176,289.119,4.341,233.021,99.238l-81.25,137.471L0.142,334.504l158.339,89.288l0,0 c-28.049,47.448-11.403,108.116,37.167,135.513c48.591,27.396,110.708,11.138,138.757-36.311l158.339,89.287l10.894-177.147 l81.25-137.471C640.987,202.765,607.695,81.41,510.533,26.617z M215.967,524.932c-29.15-16.442-39.126-52.834-22.317-81.312 l105.566,59.525C282.387,531.623,245.118,541.373,215.967,524.932z M549.7,277.814l-81.25,137.471l-8.16,132.861L73.233,329.894 l113.726-73.335l81.25-137.471C313.088,43.161,412.473,17.152,490.215,60.99C567.958,104.808,594.579,201.888,549.7,277.814z"/></g></g></g></svg>
    </div>
</a>
            <a href="#">
                <div>
                    <span class="schet">2</span>  
                    <svg class="uv-sms" id="Layer_1" enable-background="new 0 0 56 56" viewBox="0 0 56 56" xmlns="http://www.w3.org/2000/svg"><path d="m49 12.4h-42c-2 0-4 1.7-4 4v23.2c0 2.2 1.8 4 4 4h42c2.2 0 4-1.8 4-4v-23.2c0-2.3-2-4-4-4zm-10.7 15.1 12.3-12.3c.3.3.4.8.4 1.2v23.2c0 .2 0 .3-.1.5zm-8.5 5.6c-1 1-2.7 1-3.7 0l-18.7-18.7h41.1zm-24.7 7c-.1-.2-.1-.3-.1-.5v-23.2c0-.5.2-.9.4-1.2l12.3 12.3zm1.9 1.5c-.2 0-.3 0-.5-.1l12.6-12.6 5.7 5.7c1.8 1.8 4.7 1.8 6.5 0l5.7-5.7 12.6 12.6c-.2 0-.3.1-.5.1z"/></svg>
                </div>
            </a>
            </div>      

            <!--Хлебные крошки-->
            <div class="col-md-10 m-auto">
                <nav aria-label="breadcrumb" class="breadcrumb">
                    <ol class="breadcrumb p-2 rounded">
{% if request.resolver_match.url_name != 'course_list' %}
<svg onclick="history.back()" id="Layer_1" enable-background="new 0 0 128 128" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="arrow-left">
    <circle cx="57" cy="56" r="3"/>
    <path d="m7.6 64c0 3.2 1.2 6.2 3.5 8.5l34.3 34.3c2.3 2.3 5.4 3.5 8.5 3.5s6.1-1.2 8.5-3.5c2.3-2.3 3.5-5.3 3.5-8.5s-1.2-6.2-3.5-8.5l-14.8-14.8h66.4c1.7 0 3-1.3 3-3s-1.3-3-3-3h-73.7c-1.2 0-2.3.7-2.8 1.9s-.2 2.4.7 3.3l20 20c2.3 2.3 2.3 6.1 0 8.5-2.3 2.3-6.1 2.3-8.5 0l-34.4-34.5c-1.1-1.1-1.8-2.6-1.8-4.2s.6-3.1 1.8-4.2l34.3-34.3c2.3-2.3 6.1-2.3 8.5 0 2.3 2.3 2.3 6.1 0 8.5l-20 20c-.9.9-1.1 2.1-.7 3.3s1.6 1.9 2.8 1.9h53.8c1.7 0 3-1.3 3-3s-1.3-3-3-3h-46.4l14.9-14.9c2.3-2.3 3.5-5.3 3.5-8.5s-1.2-6.2-3.5-8.5c-4.7-4.7-12.3-4.7-17 0l-34.4 34.2c-2.3 2.3-3.5 5.3-3.5 8.5z"/></svg>
{% endif %}                  
    {% dynamic_breadcrumbs as crumbs %}
                        {% for crumb in crumbs %}
                            <li class="breadcrumb-item{% if not crumb.url or forloop.last %} active{% endif %}">
                                {% if crumb.url and not forloop.last %}
                                    <a href="{{ crumb.url }}" class="text-decoration-none breadcrumb-link">{{ crumb.title }}</a>
                                {% else %}
                                    <span>{{ crumb.title }}</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ol>
                </nav>
            </div>
            <!-- Основное содержимое -->
            <div class="row">
                <div class="col-md-12">
                    <!--Уведомления 2-->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    {% block content %}
                    <!--Тут информация с шаблонов-->
                    {% endblock %}
                </div>
            </div>
        </div>
            <!-- Подвал -->
    <footer>
        <span class="">Система дистанционного обучения © {% now "Y" %}</span>
    </footer>
    </div>


      <!--Наследование JS с шаблонов-->
      {% block extra_js %}{% endblock %}
    <!-- Bootstrap JS и зависимости -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS для реализации выборки по клику мыши -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="{% static 'js/base.js' %}"></script> 
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/smoothscroll/1.4.10/SmoothScroll.min.js" ></script>
<script>
SmoothScroll({
    // Время скролла 400 = 0.4 секунды
    animationTime    : 600,
    // Размер шага в пикселях 
    stepSize         : 30,
    // Дополнительные настройки: 
    // Ускорение 
    accelerationDelta :15,  
    // Максимальное ускорение
    accelerationMax   : 2,   
    // Поддержка клавиатуры
    keyboardSupport   : true,  
    // Шаг скролла стрелками на клавиатуре в пикселях
    arrowScroll       : 50,
    // Pulse (less tweakable)
    // ratio of "tail" to "acceleration"
    pulseAlgorithm   : true,
    pulseScale       : 4,
    pulseNormalize   : 1,
    // Поддержка тачпада
    touchpadSupport   : true,
})
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function updateNotificationCount() {
        fetch('{% url "get_unread_count" %}')
            .then(response => response.json())
            .then(data => {
                const counter = document.querySelector('.schet');
                const notificationIcon = document.querySelector('a[href="{% url 'notifications' %}"] div');
                
                if (data.count > 0) {
                    if (!counter) {
                        // Создаем элемент счетчика если его нет
                        const span = document.createElement('span');
                        span.className = 'schet';
                        span.textContent = data.count;
                        notificationIcon.insertBefore(span, notificationIcon.firstChild);
                    } else {
                        // Обновляем существующий счетчик
                        counter.textContent = data.count;
                    }
                } else if (counter) {
                    // Удаляем счетчик если нет уведомлений
                    counter.remove();
                }
            })
            .catch(error => console.error('Error updating notification count:', error));
    }
    
    // Обновляем счетчик каждые 30 секунд
    setInterval(updateNotificationCount, 30000);
    // Обновляем сразу при загрузке страницы
    updateNotificationCount();
});
</script>


<script>
// Обновление счетчика каждые 30 секунд
function updateNotificationCount() {
    fetch('{% url "get_unread_count" %}')
        .then(response => response.json())
        .then(data => {
            const counter = document.getElementById('notification-counter');
            const bell = document.getElementById('notification-bell');
            
            if (data.count > 0) {
                if (!counter) {
                    const span = document.createElement('span');
                    span.className = 'schet';
                    span.id = 'notification-counter';
                    span.textContent = data.count;
                    bell.querySelector('div').prepend(span);
                } else {
                    counter.textContent = data.count;
                }
            } else if (counter) {
                counter.remove();
            }
        });
}

setInterval(updateNotificationCount, 30000);
updateNotificationCount();
</script>
</body>
</html>