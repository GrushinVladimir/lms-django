{% extends 'lms_cleint/base.html' %}
{% block extra_css %}
<style>
    .drag-handle {
        cursor: move;
        color: #6c757d; /* Серый цвет */
        padding: 0 10px;
        margin-left: 10px;
        user-select: none; /* Предотвращает выделение текста при перетаскивании */
    }
    .list-group-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .material-content {
        flex-grow: 1;
    }
    .material-actions {
        display: flex;
        align-items: center;
    }
</style>
{% endblock %}
{% block content %}
<h2>Глава: {{ chapter.name }}</h2>

<h3 class="mt-4">Материалы главы</h3>
<div class="mb-3">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFileModal">
        Добавить файл
    </button>
    <a href="{% url 'create_article' chapter.id %}" class="btn btn-success">
        Создать статью
    </a>
    <a href="{% url 'create_test' chapter.id %}" class="btn btn-info">
        Создать тест
    </a>
</div>

<!-- Объединенный список материалов -->
<!-- Обновим список материалов -->
<ul id="materials-list" class="list-group" data-chapter-id="{{ chapter.id }}">
    {% for material in materials %}
    <li class="list-group-item" 
        data-id="{% if material.material_type == 'file' %}file_{% elif material.material_type == 'article' %}article_{% else %}test_{% endif %}{{ material.id }}" 
        data-type="{{ material.material_type }}">
        <div class="material-content">
            <strong>
                {% if material.material_type == 'file' %}
                    {{ material.display_name }}
                {% elif material.material_type == 'article' %}
                    {{ material.title }}
                {% else %}
                    {{ material.title }}
                {% endif %}
            </strong>
            <span class="badge 
                {% if material.material_type == 'file' %}bg-primary
                {% elif material.material_type == 'article' %}bg-success
                {% else %}bg-info{% endif %}">
                {% if material.material_type == 'file' %}
                    {% if material.is_pdf %}PDF
                    {% elif material.is_word %}Word
                    {% else %}Файл{% endif %}
                {% elif material.material_type == 'article' %}
                    Статья
                {% else %}
                    Тест
                {% endif %}
            </span>
        </div>
        <div class="material-actions">
            <div class="btn-group">
                {% if material.material_type == 'file' %}
                    {% if material.is_pdf %}
                    <a href="{{ material.file.url }}" class="btn btn-sm btn-info" target="_blank">Просмотреть</a>
                    {% else %}
                    <a href="{{ material.file.url }}" class="btn btn-sm btn-info" download>Скачать</a>
                    {% endif %}
                    <a href="{% url 'delete_file' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
                {% elif material.material_type == 'article' %}
                    <a href="{% url 'article_detail' material.id %}" class="btn btn-sm btn-info">Просмотреть</a>
                    <a href="{% url 'edit_article' material.id %}" class="btn btn-sm btn-warning">Редактировать</a>
                    <a href="{% url 'delete_article' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
                {% else %}
                    <a href="{% url 'view_test' material.id %}" class="btn btn-sm btn-info">Просмотреть</a>
                    <a href="{% url 'edit_test' material.id %}" class="btn btn-sm btn-warning">Редактировать</a>
                    <a href="{% url 'delete_test' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
                {% endif %}
            </div>
            <div class="drag-handle">⋮</div>
        </div>
    </li>
    {% empty %}
    <li class="list-group-item">Материалы пока не добавлены</li>
    {% endfor %}
</ul>

<!-- Модальное окно для добавления файла -->
<div class="modal fade" id="addFileModal" tabindex="-1" aria-labelledby="addFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFileModalLabel">Загрузить новый файл</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" enctype="multipart/form-data" id="fileUploadForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="{{ form.display_name.id_for_label }}" class="form-label">{{ form.display_name.label }}</label>
                        {{ form.display_name }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.file.id_for_label }}" class="form-label">{{ form.file.label }}</label>
                        {{ form.file }}
                        <div class="form-text">Поддерживаются файлы PDF и Word</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="submit" class="btn btn-primary">Загрузить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="{% url 'chapter_list' chapter.subject.id %}" class="btn btn-secondary">Вернуться к главам</a>
</div>

{% endblock %}

{% block extra_js %}
<!-- Подключаем SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var materialsList = document.getElementById('materials-list');
    var chapterId = materialsList.dataset.chapterId;

    if (materialsList) {
        new Sortable(materialsList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            handle: '.drag-handle', // Указываем класс элемента, за который можно тянуть
            onEnd: function (evt) {
                var order = Array.from(materialsList.children).map(function(item) {
                    return item.dataset.id;
                });

                fetch('/chapter/' + chapterId + '/update_materials_order/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({order: order})
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Order updated successfully');
                        showToast('Порядок материалов сохранён');
                    } else {
                        console.error('Error updating order:', data.message);
                        showToast('Ошибка при сохранении порядка', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Ошибка при сохранении порядка', 'error');
                });
            }
        });
    }
});

// Функция для показа уведомлений
function showToast(message, type = 'success') {
    // Реализация зависит от вашей системы уведомлений
    // Например, можно использовать Bootstrap Toast или просто alert
    alert(message);
}
</script>
{% endblock %}