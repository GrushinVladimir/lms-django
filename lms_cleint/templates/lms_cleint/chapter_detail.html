{% extends 'lms_cleint/base.html' %}
{% block extra_css %}
<style>
    .drag-handle {
        cursor: move;
        color: #6c757d;
        padding: 0 10px;
        margin-left: 10px;
        user-select: none;
    }
    .list-group-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .material-content {
        flex-grow: 1;
    }
    .material-actions {
        display: flex;
        align-items: center;
    }
    .video-modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .video-modal-content {
        background-color: #fefefe;
        margin: 9% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1100;
    }
</style>
{% endblock %}

{% block content %}
<p>{{ chapter.name }} / {{ chapter.subject.name }}</p>


<h3 class="mt-4">Материалы главы</h3>
<div class="mb-3">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFileModal">
        Добавить файл
    </button>
    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addVideoModal">
        Добавить видео
    </button>
    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addLinkModal">
        Добавить ссылку
    </button>
    <a href="{% url 'create_article' chapter.id %}" class="btn btn-success">
        Создать статью
    </a>
    <a href="{% url 'create_test' chapter.id %}" class="btn btn-info">
        Создать тест
    </a>
</div>

<ul id="materials-list" class="list-group" data-chapter-id="{{ chapter.id }}">
{% for material in materials %}

<li class="list-group-item"
    data-id="{% if material.material_type == 'file' %}file_{% elif material.material_type == 'article' %}article_{% elif material.material_type == 'test' %}test_{% elif material.material_type == 'video' %}video_{% elif material.material_type == 'link' %}link_{% endif %}{{ material.id }}"
    data-type="{{ material.material_type }}">
    <div class="material-content">
        <strong>
            {% if material.material_type == 'file' %}
            
                {{ material.display_name|default:material.file.name }}
            {% elif material.material_type == 'article' %}
                {{ material.title }}
            {% elif material.material_type == 'test' %}
                {{ material.title }}
            {% elif material.material_type == 'video' %}
                {{ material.title }}
            {% elif material.material_type == 'link' %}
                <a href="{{ material.url }}" target="_blank">{{ material.title }}</a>
            {% endif %}
        </strong>
        <span class="badge
            {% if material.material_type == 'file' %}bg-success
            {% elif material.material_type == 'article' %}bg-success
            {% elif material.material_type == 'test' %}bg-success
            {% elif material.material_type == 'video' %}bg-success
            {% elif material.material_type == 'link' %}bg-success{% endif %}">
            {% if material.material_type == 'file' %}
                {% if material.is_pdf %}PDF
                {% elif material.is_word %}Word
                {% elif material.is_ppt %}PowerPoint
                {% else %}Файл{% endif %}
            {% elif material.material_type == 'article' %}
                Статья
            {% elif material.material_type == 'test' %}
                Тест
            {% elif material.material_type == 'video' %}
                Видео
            {% elif material.material_type == 'link' %}
                Ссылка
            {% endif %}
        </span>
    </div>
    <div class="material-actions">
        <!-- Обработка для каждого типа материала -->
        {% if material.material_type == 'file' %}
        
            <div class="btn-group">
                {% if material.provide_answer %}
                    <!-- Обработка для файлов с ответами -->
                {% endif %}
                {% if material.is_pdf %}
                    <a href="{{ material.file.url }}" class="btn btn-sm btn-info" target="_blank">Просмотреть</a>
                {% else %}
                    <a href="{{ material.file.url }}" class="btn btn-sm btn-info" download>Скачать</a>
                {% endif %}
                <button class="btn btn-sm btn-warning edit-file-btn" data-id="{{ material.id }}">Редактировать</button>
                <a href="{% url 'delete_file' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% elif material.material_type == 'article' %}
            <div class="btn-group">
                <a href="{% url 'article_detail' material.id %}" class="btn btn-sm btn-info">Просмотреть</a>
                <a href="{% url 'edit_article' material.id %}" class="btn btn-sm btn-warning">Редактировать</a>
                <a href="{% url 'delete_article' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% elif material.material_type == 'test' %}
            <div class="btn-group">
                <a href="{% url 'view_test' material.id %}" class="btn btn-sm btn-info">Выполнить тест</a>
                <a href="{% url 'edit_test' material.id %}" class="btn btn-sm btn-warning">Редактировать</a>
                <a href="{% url 'delete_test' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% elif material.material_type == 'video' %}
            <div class="btn-group">
                <button class="btn btn-sm btn-info" onclick="openVideoModal('{{ material.video_url }}')">Воспроизвести</button>
                <button class="btn btn-sm btn-warning edit-video-btn" data-id="{{ material.id }}">Редактировать</button>
                <a href="{% url 'delete_video' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% elif material.material_type == 'link' %}
            <div class="btn-group">
                <a href="{{ material.url }}" class="btn btn-sm btn-info" target="_blank">Открыть</a>
                <button class="btn btn-sm btn-warning edit-link-btn" data-id="{{ material.id }}">Редактировать</button>
                <a href="{% url 'delete_link' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% endif %}
        <div class="drag-handle">⋮</div>
    </div>
</li>
{% empty %}
<li class="list-group-item">Материалы пока не добавлены</li>
{% endfor %}
</ul>

<!-- Модальные окна -->
{% include 'lms_cleint/modals/confirm_completion.html' %}
{% include 'lms_cleint/modals/add_answer.html' %}
{% include 'lms_cleint/modals/add_file.html' %}
{% include 'lms_cleint/modals/add_video.html' %}
{% include 'lms_cleint/modals/add_link.html' %}
{% include 'lms_cleint/modals/edit_file.html' %}
{% include 'lms_cleint/modals/edit_video.html' %}
{% include 'lms_cleint/modals/edit_link.html' %}
{% include 'lms_cleint/modals/video_view.html' %}

<div class="mt-3">
    <a href="{% url 'chapter_list' chapter.subject.id %}" class="btn btn-secondary">Вернуться к главам</a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
// Глобальные переменные
let currentMaterialToComplete = null;

// Функция для показа уведомлений
function showDynamicToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true" style="background:#d1e7dd; color:#0a3622;">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-black me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>`;
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastEl = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', function() {
        toastEl.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const chapterId = document.getElementById('materials-list')?.dataset.chapterId;

    // Инициализация сортировки
    initSortable(chapterId);

    // Обработчики событий
    setupEventHandlers();

    // Проверяем, есть ли файлы с ответами и обновляем кнопки
    updateAnswerButtons();
});

// Инициализация сортировки
function initSortable(chapterId) {
    const materialsList = document.getElementById('materials-list');
    if (materialsList) {
        new Sortable(materialsList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            handle: '.drag-handle',
            onEnd: function() {
                const order = Array.from(materialsList.children).map(item => item.dataset.id);
                saveMaterialsOrder(chapterId, order);
            }
        });
    }
}

// Сохранение порядка материалов
function saveMaterialsOrder(chapterId, order) {
    fetch('/chapter/' + chapterId + '/update_materials_order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({order: order})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Порядок сохранён');
        } else {
            showDynamicToast('Ошибка при сохранении порядка', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при сохранении порядка', 'danger');
        console.error('Ошибка:', error);
    });
}

// Настройка обработчиков событий
function setupEventHandlers() {
    // Обработчики кнопок "Добавить ответ"
    document.querySelectorAll('.add-answer-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('fileId').value = this.dataset.id;
            // Явно показываем модальное окно
            const modal = new bootstrap.Modal(document.getElementById('addAnswerModal'));
            modal.show();
        });
    });

    // Обработчик формы загрузки ответа
    document.getElementById('answerUploadForm').addEventListener('submit', handleAnswerUpload);

    // Обработчики форм
    document.getElementById('fileUploadForm')?.addEventListener('submit', handleFileUpload);
    document.getElementById('videoUploadForm')?.addEventListener('submit', handleVideoUpload);
    document.getElementById('linkUploadForm')?.addEventListener('submit', handleLinkUpload);
    document.getElementById('editFileForm')?.addEventListener('submit', handleEditFile);
    document.getElementById('editVideoForm')?.addEventListener('submit', handleEditVideo);
    document.getElementById('editLinkForm')?.addEventListener('submit', handleEditLink);

    // Обработчики кнопок редактирования
    document.querySelectorAll('.edit-file-btn').forEach(btn => {
        btn.addEventListener('click', showEditFileModal);
    });
    document.querySelectorAll('.edit-video-btn').forEach(btn => {
        btn.addEventListener('click', showEditVideoModal);
    });
    document.querySelectorAll('.edit-link-btn').forEach(btn => {
        btn.addEventListener('click', showEditLinkModal);
    });

    // Обработчик кнопки "Изменить" в модальном окне редактирования файла
    document.getElementById('changeFileBtn')?.addEventListener('click', function() {
        document.getElementById('newFileForm').style.display = 'block';
        this.style.display = 'none';
    });
}

// Обновление кнопок "Добавить ответ"
function updateAnswerButtons() {
    document.querySelectorAll('.add-answer-btn').forEach(btn => {
        const fileId = btn.dataset.id;
        // Можно добавить дополнительную логику инициализации здесь
    });
}

// Загрузка ответа
function handleAnswerUpload(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const fileId = document.getElementById('fileId').value;

    fetch('/upload_answer/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Ответ успешно загружен');
            bootstrap.Modal.getInstance(document.getElementById('addAnswerModal')).hide();
            // Обновляем все кнопки для этого файла
            document.querySelectorAll(`.add-answer-btn[data-id="${fileId}"]`).forEach(button => {
                button.textContent = data.short_name || 'Ответ';
                if (data.file_name) {
                    button.title = data.file_name;
                }
            });
        } else {
            showDynamicToast(data.message || 'Ошибка при загрузке ответа', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при загрузке ответа', 'danger');
        console.error('Error:', error);
    });
}

// Загрузка файла
function handleFileUpload(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const chapterId = document.getElementById('materials-list').dataset.chapterId;

    fetch('/chapter/' + chapterId + '/upload_file/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Файл успешно загружен');
            // Закрываем модальное окно
            bootstrap.Modal.getInstance(document.getElementById('addFileModal')).hide();
            // Обновляем страницу
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при загрузке файла', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showDynamicToast(error.message || 'Ошибка при загрузке файла', 'danger');
    });
}

// Загрузка видео
function handleVideoUpload(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const chapterId = document.getElementById('materials-list').dataset.chapterId;

    fetch('/chapter/' + chapterId + '/upload_video/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Видео успешно загружено');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при загрузке видео', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при загрузке видео', 'danger');
    });
}

// Добавление ссылки
function handleLinkUpload(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const chapterId = document.getElementById('materials-list').dataset.chapterId;

    fetch('/chapter/' + chapterId + '/add_link/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Ссылка успешно добавлена');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при добавлении ссылки', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при добавлении ссылки', 'danger');
    });
}

// Редактирование файла
function showEditFileModal() {
    const fileId = this.dataset.id;
    fetch(`/chapter/file/${fileId}/get/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('editFileId').value = fileId;
        document.getElementById('editFileName').value = data.display_name;

        const currentFileLink = document.getElementById('currentFileLink');
        const currentFileName = document.getElementById('currentFileName');
        const newFileForm = document.getElementById('newFileForm');

        if (data.file_url) {
            currentFileLink.href = data.file_url;
            currentFileName.textContent = data.file_name || 'Файл';
            currentFileLink.style.display = 'inline-block';
            newFileForm.style.display = 'none';
            document.getElementById('changeFileBtn').style.display = 'inline-block';
        } else {
            currentFileLink.style.display = 'none';
            currentFileName.textContent = 'Файл не загружен';
            newFileForm.style.display = 'block';
            document.getElementById('changeFileBtn').style.display = 'none';
        }

        new bootstrap.Modal(document.getElementById('editFileModal')).show();
    });
}

function handleEditFile(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/chapter/file/update/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Файл успешно обновлен');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при сохранении', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при сохранении', 'danger');
    });
}

// Редактирование видео
function showEditVideoModal() {
    const videoId = this.dataset.id;
    fetch(`/chapter/video/${videoId}/get/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('editVideoId').value = videoId;
        document.getElementById('editVideoTitle').value = data.title;
        document.getElementById('editVideoUrl').value = data.video_url || '';
        new bootstrap.Modal(document.getElementById('editVideoModal')).show();
    });
}

function handleEditVideo(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/chapter/video/update/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Видео успешно обновлено');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при сохранении', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при сохранении', 'danger');
    });
}

// Редактирование ссылки
function showEditLinkModal() {
    const linkId = this.dataset.id;
    fetch(`/chapter/link/${linkId}/get/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('editLinkId').value = linkId;
        document.getElementById('editLinkTitle').value = data.title;
        document.getElementById('editLinkUrl').value = data.url;
        new bootstrap.Modal(document.getElementById('editLinkModal')).show();
    });
}

function handleEditLink(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/chapter/link/update/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Ссылка успешно обновлена');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при сохранении', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при сохранении', 'danger');
    });
}

// Функции для работы с видео
function openVideoModal(videoUrl) {
    const modal = document.getElementById('videoModal');
    const videoContainer = document.getElementById('videoContainer');

    if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
        let videoId = videoUrl.split('v=')[1];
        if (!videoId) videoId = videoUrl.split('youtu.be/')[1];
        if (videoId) videoId = videoId.split('&')[0];

        videoContainer.innerHTML = `
            <iframe width="100%" height="700"
                src="https://www.youtube.com/embed/${videoId}"
                frameborder="0"
                allowfullscreen>
            </iframe>`;
    } else {
        videoContainer.innerHTML = `
            <video width="100%" height="700" controls>
                <source src="${videoUrl}" type="video/mp4">
                Ваш браузер не поддерживает видео.
            </video>`;
    }

    modal.style.display = "block";
}

function closeVideoModal() {
    document.getElementById('videoModal').style.display = "none";
    document.getElementById('videoContainer').innerHTML = '';
}

window.onclick = function(event) {
    const modal = document.getElementById('videoModal');
    if (event.target == modal) {
        closeVideoModal();
    }
}
</script>
{% endblock %}