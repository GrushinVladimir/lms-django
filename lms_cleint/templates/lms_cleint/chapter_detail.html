{% extends 'lms_cleint/base.html' %}
{% block extra_css %}
<style>
        .progress-bar {
        transition: width 0.5s ease-in-out;
    }
    .list-group-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .material-content {
        display: flex;
        justify-content: flex-start;
        width: 100%;
    }
    .material-actions {
        display: flex;
        align-items: center;
    }
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1100;
    }
    .material-badge {
        margin-left: 10px;
    }
    .answer-section {
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    .video-modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .video-modal-content {
        background-color: #fefefe;
        margin: 9% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    /* Стили для уведомлений */
    .notification-badge {
        position: relative;
        display: inline-block;
        margin-right: 10px;
    }
    .notification-dot {
   
    }
    .grade-modal-content {
        padding: 20px;
    }
    .grade-badge {
        font-size: 1.1em;
        padding: 5px 10px;
    }

.notification-dot.notification-seen + svg.bell {
  fill: #a0a0a0 !important;
  animation: none;
  transform: rotate(15deg);
}
.bell {
  transform: rotate(15deg); /* Изначальный наклон */
  z-index: 2;
  fill: #76bdad; /* Исходный цвет (зелёный/бирюзовый) */
  position: relative;
  transform-origin: 50% 0;
  animation: ring 3s infinite ease-in-out;
  transition: fill 0.3s ease; /* Плавное изменение цвета */
}

.notification-seen .bell {
  fill: #a0a0a0 !important; /* Серый цвет при просмотре */
  animation: none; /* Останавливаем анимацию */
  transform: rotate(15deg); /* Фиксируем положение */
}

@keyframes ring {
  0%, 40%, 100% {
    transform: rotate(15deg);
  }
  10% {
    transform: rotate(35deg);
  }
  20% {
    transform: rotate(-5deg);
  }
  30% {
    transform: rotate(35deg);
  }
}
.bell, .checkmark {
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.notification-badge {
    position: relative;
    display: inline-block;
    margin-right: 10px;
}

.notification-badge svg {
    vertical-align: middle;
}

    .drag-handle {
        cursor: move;
        color: #6c757d;
        padding: 0 10px;
        margin-left: 10px;
        user-select: none;
    }
    .list-group-items {

    background-color: var(--bs-list-group-bg);
    border: var(--bs-list-group-border-width) solid var(--bs-list-group-border-color);


    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: .5rem;
    }
    .material-content {
        flex-grow: 1;
    }
    .material-actions {
        justify-content: space-between;
        display: flex;
        align-items: center;
    }
    .video-modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .video-modal-content {
        background-color: #fefefe;
        margin: 9% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1100;
    }
    /* Стили для кнопки просмотра ответов */
    .view-answers-btn {
        position: relative;
        margin-right: 5px;
    }
    .answer-count-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 0.7em;
    }
    #answersTableBody tr {
        cursor: pointer;
    }
    #answersTableBody tr:hover {
        background-color: #f8f9fa;
    }
    .grade-input {
        width: 60px;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
<h3 class="mt-4">Материалы главы</h3>
<div class="mb-3">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFileModal">
        Добавить файл
    </button>
    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addVideoModal">
        Добавить видео
    </button>
    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addLinkModal">
        Добавить ссылку
    </button>
    <a href="{% url 'create_article' chapter.id %}" class="btn btn-success">
        Создать статью
    </a>
    <a href="{% url 'create_test' chapter.id %}" class="btn btn-info">
        Создать тест
    </a>
</div>

<ul id="materials-list" class="list-group" data-chapter-id="{{ chapter.id }}">
{% for material in materials %}
<li class="list-group-items mb-1"
    data-id="{% if material.material_type == 'file' %}file_{% elif material.material_type == 'article' %}article_{% elif material.material_type == 'test' %}test_{% elif material.material_type == 'video' %}video_{% elif material.material_type == 'link' %}link_{% endif %}{{ material.id }}"
    data-type="{{ material.material_type }}">
    <div class="material-content">
        <strong>
            {% if material.material_type == 'file' %}
                {{ material.display_name|default:material.file.name }}
            {% elif material.material_type == 'article' %}
                {{ material.title }}
            {% elif material.material_type == 'test' %}
                {{ material.title }}
            {% elif material.material_type == 'video' %}
                {{ material.title }}
            {% elif material.material_type == 'link' %}
                <a href="{{ material.url }}" target="_blank">{{ material.title }}</a>
            {% endif %}
        </strong>
        <span class="badge
            {% if material.material_type == 'file' %}bg-success
            {% elif material.material_type == 'article' %}bg-success
            {% elif material.material_type == 'test' %}bg-success
            {% elif material.material_type == 'video' %}bg-success
            {% elif material.material_type == 'link' %}bg-success{% endif %}">
            {% if material.material_type == 'file' %}
                {% if material.is_pdf %}PDF
                {% elif material.is_word %}Word
                {% elif material.is_ppt %}PowerPoint
                {% else %}Файл{% endif %}
            {% elif material.material_type == 'article' %}
                Статья
            {% elif material.material_type == 'test' %}
                Тест
            {% elif material.material_type == 'video' %}
                Видео
            {% elif material.material_type == 'link' %}
                Ссылка
            {% endif %}
        </span>
    </div>
    <div class="material-actions">
        <!-- Обработка для каждого типа материала -->
        {% if material.material_type == 'file' %}
            <div class="btn-group">
                {% if material.provide_answer %}
                    <!-- Кнопка просмотра ответов студентов -->
<button class="btn btn-sm btn-info view-answers-btn" 
        data-file-id="{{ material.id }}"
        data-bs-toggle="modal" 
        data-bs-target="#studentAnswersModal">
    <i class="fas fa-users"></i>
    <span class="badge bg-danger answer-count-badge">
        {{ material.answers.count }}
    </span>
</button>
                {% endif %}
                {% if material.is_pdf %}
                    <a href="{{ material.file.url }}" class="btn btn-sm btn-info" target="_blank">Просмотреть</a>
                {% else %}
                    <a href="{{ material.file.url }}" class="btn btn-sm btn-info" download>Скачать</a>
                {% endif %}
                <button class="btn btn-sm btn-warning edit-file-btn" data-id="{{ material.id }}">Редактировать</button>
                <a href="{% url 'delete_file' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% elif material.material_type == 'article' %}
            <div class="btn-group">
                <a href="{% url 'article_detail' material.id %}" class="btn btn-sm btn-info">Просмотреть</a>
                <a href="{% url 'edit_article' material.id %}" class="btn btn-sm btn-warning">Редактировать</a>
                <a href="{% url 'delete_article' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% elif material.material_type == 'test' %}
            <div class="btn-group">
                <a href="{% url 'view_test' material.id %}" class="btn btn-sm btn-info">Выполнить тест</a>
                <a href="{% url 'edit_test' material.id %}" class="btn btn-sm btn-warning">Редактировать</a>
                <a href="{% url 'delete_test' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% elif material.material_type == 'video' %}
            <div class="btn-group">
                <button class="btn btn-sm btn-info" onclick="openVideoModal('{{ material.video_url }}')">Воспроизвести</button>
                <button class="btn btn-sm btn-warning edit-video-btn" data-id="{{ material.id }}">Редактировать</button>
                <a href="{% url 'delete_video' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% elif material.material_type == 'link' %}
            <div class="btn-group">
                <a href="{{ material.url }}" class="btn btn-sm btn-info" target="_blank">Открыть</a>
                <button class="btn btn-sm btn-warning edit-link-btn" data-id="{{ material.id }}">Редактировать</button>
                <a href="{% url 'delete_link' material.id %}" class="btn btn-sm btn-danger">Удалить</a>
            </div>
        {% endif %}
        <div class="drag-handle">⋮</div>
    </div>
</li>
{% empty %}
<li class="list-group-items">Материалы пока не добавлены</li>
{% endfor %}
</ul>

<!-- Модальное окно со списком студентов -->
<!-- Модальное окно со списком студентов -->
<div class="modal fade" id="studentAnswersModal" tabindex="-1" aria-labelledby="studentAnswersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentAnswersModalLabel">Ответы студентов</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Фильтр по группам -->
                <div class="mb-3">
                    <label for="groupFilter" class="form-label">Фильтр по группам:</label>
                    <select class="form-select" id="groupFilter">
                        <option value="all">Все группы</option>
                        {% for group in chapter.student_groups.all %}
                            <option value="{{ group.id }}">{{ group.group_number }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Таблица с ответами студентов -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Студент</th>
                                <th>Группа</th>
                                <th>Файл ответа</th>
                                <th>Дата загрузки</th>
                                <th>Оценка</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="answersTableBody">
                            {% for answer in material.answers.all %}
                            <tr data-answer-id="{{ answer.id }}">
                                <td>
                                    <a href="{% url 'student_profile' answer.student.studentprofile.id %}" class="student-name-link">
                                        {{ answer.student.last_name }} {{ answer.student.first_name }}
                                    </a>
                                </td>
                                <td>{{ answer.student.studentprofile.group.group_number }}</td>
                                <td>
                                    <a href="{{ answer.file.url }}" target="_blank" title="{{ answer.file.name }}">
                                        {{ answer.file.name|truncatechars:20 }}
                                    </a>
                                </td>
                                <td>{{ answer.uploaded_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    {% if answer.grade is not None %}
                                        <span class="badge bg-{% if answer.grade >= 5 %}success{% else %}warning{% endif %}">
                                            {{ answer.grade }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary grade-answer-btn" 
                                            data-answer-id="{{ answer.id }}"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#gradeAnswerModal">
                                        Оценить
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">Нет ответов студентов</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для оценки ответа -->
<div class="modal fade" id="gradeAnswerModal" tabindex="-1" aria-labelledby="gradeAnswerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gradeAnswerModalLabel">Оценить ответ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="gradeAnswerForm">
                    <input type="hidden" id="answerIdToGrade" name="answer_id">
                    <div class="mb-3">
                        <label for="gradeInput" class="form-label">Оценка (0-10):</label>
                        <input type="number" class="form-control grade-input" id="gradeInput" 
                               name="grade" min="0" max="10" required>
                    </div>
                    <div class="mb-3">
                        <label for="feedbackInput" class="form-label">Комментарий:</label>
                        <textarea class="form-control" id="feedbackInput" name="feedback" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveGradeBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="{% url 'chapter_list' chapter.subject.id %}" class="btn btn-secondary">Вернуться к главам</a>
</div>

<!-- Модальные окна -->
{% include 'lms_cleint/modals/add_file.html' %}
{% include 'lms_cleint/modals/add_video.html' %}
{% include 'lms_cleint/modals/add_link.html' %}
{% include 'lms_cleint/modals/edit_file.html' %}
{% include 'lms_cleint/modals/edit_video.html' %}
{% include 'lms_cleint/modals/edit_link.html' %}
{% include 'lms_cleint/modals/video_view.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
// Глобальные переменные
let currentMaterialToComplete = null;

function showToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container') || (() => {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(container);
        return container;
    })();

    const toastId = 'toast-' + Date.now();
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>`;

    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastEl = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();

    // Автоматическое удаление через 5 секунд
    setTimeout(() => toast.dispose(), 5000);
}



// Функция для показа уведомлений
function showDynamicToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true" style="background:#d1e7dd; color:#0a3622;">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-black me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>`;
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastEl = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', function() {
        toastEl.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const chapterId = document.getElementById('materials-list')?.dataset.chapterId;

    // Инициализация сортировки
    initSortable(chapterId);

    // Обработчики событий
    setupEventHandlers();

    // Обработчик для кнопки просмотра ответов
document.querySelectorAll('.view-answers-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const fileId = this.getAttribute('data-file-id');
        // Сохраняем fileId в модальном окне для фильтрации
        document.getElementById('studentAnswersModal').dataset.fileId = fileId;
        
        // Загружаем ответы студентов
        loadStudentAnswers(fileId);
    });
});
    
    // Обработчик изменения фильтра групп
document.getElementById('groupFilter')?.addEventListener('change', function() {
    const fileId = document.getElementById('studentAnswersModal').dataset.fileId;
    if (fileId) {
        loadStudentAnswers(fileId, this.value);
    }
});
    
    // Обработчик для кнопки оценки ответа
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('grade-answer-btn')) {
            const answerId = e.target.getAttribute('data-answer-id');
            document.getElementById('answerIdToGrade').value = answerId;
        }
    });
    
    // Обработчик сохранения оценки
    document.getElementById('saveGradeBtn')?.addEventListener('click', function() {
        const form = document.getElementById('gradeAnswerForm');
        const formData = new FormData(form);
        
        fetch('/grade_file_answer/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showDynamicToast('Оценка сохранена');
                // Закрываем модальное окно
                bootstrap.Modal.getInstance(document.getElementById('gradeAnswerModal')).hide();
                // Обновляем таблицу с ответами
                const fileId = document.querySelector('#studentAnswersModal').dataset.fileId;
                const groupId = document.getElementById('groupFilter').value;
                if (fileId) {
                    loadStudentAnswers(fileId, groupId);
                }
            } else {
                showDynamicToast(data.message || 'Ошибка при сохранении оценки', 'danger');
            }
        })
        .catch(error => {
            showDynamicToast('Ошибка при сохранении оценки', 'danger');
            console.error('Error:', error);
        });
    });
});
// Загрузка файла
function handleFileUpload(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const chapterId = document.getElementById('materials-list').dataset.chapterId;

    fetch('/chapter/' + chapterId + '/upload_file/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Файл успешно загружен');
            bootstrap.Modal.getInstance(document.getElementById('addFileModal')).hide();
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при загрузке файла', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showDynamicToast(error.message || 'Ошибка при загрузке файла', 'danger');
    });
}

// Загрузка видео
function handleVideoUpload(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const chapterId = document.getElementById('materials-list').dataset.chapterId;

    fetch('/chapter/' + chapterId + '/upload_video/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Видео успешно загружено');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при загрузке видео', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при загрузке видео', 'danger');
    });
}

// Добавление ссылки
function handleLinkUpload(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const chapterId = document.getElementById('materials-list').dataset.chapterId;

    fetch('/chapter/' + chapterId + '/add_link/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Ссылка успешно добавлена');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при добавлении ссылки', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при добавлении ссылки', 'danger');
    });
}

// Редактирование файла
function handleEditFile(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/chapter/file/update/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Файл успешно обновлен');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при сохранении', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при сохранении', 'danger');
    });
}

// Редактирование видео
function handleEditVideo(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/chapter/video/update/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Видео успешно обновлено');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при сохранении', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при сохранении', 'danger');
    });
}

// Редактирование ссылки
function handleEditLink(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/chapter/link/update/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Ссылка успешно обновлена');
            location.reload();
        } else {
            showDynamicToast(data.message || 'Ошибка при сохранении', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при сохранении', 'danger');
    });
}
// Функция загрузки ответов студентов
function loadStudentAnswers(fileId, groupId = 'all') {
    console.log(`Loading answers for file: ${fileId}, group: ${groupId}`);

    const url = `/get_student_answers/?file_id=${fileId}` + (groupId !== 'all' ? `&group_id=${groupId}` : '');
    console.log(`Request URL: ${url}`);

    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        console.log(`Response status: ${response.status}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Received data:', data);
        const tbody = document.getElementById('answersTableBody');
        if (!tbody) {
            console.error('Element with id "answersTableBody" not found');
            return;
        }
        tbody.innerHTML = '';
        if (data.status === 'success' && data.answers && data.answers.length > 0) {
            data.answers.forEach(answer => {
                console.log('Student data:', answer.student_name);
                const row = document.createElement('tr');
                row.dataset.answerId = answer.id;
                const date = new Date(answer.uploaded_at);
                const formattedDate = date.toLocaleString('ru-RU');
                const gradeDisplay = answer.grade !== null ?
                    `<span class="badge bg-${answer.grade >= 5 ? 'success' : 'warning'}">${answer.grade}</span>` :
                    '-';
                const fileName = answer.file_url?.split('/').pop() || '';
                const shortName = fileName.length > 20 ?
                    `${fileName.substring(0, 10)}...${fileName.substring(fileName.length - 5)}` :
                    fileName;
                row.innerHTML = `
                    <td>
                        <a href="/student/${answer.student_profile_id}/" class="student-name-link">
                            ${answer.student_name || 'Неизвестный студент'}
                        </a>
                    </td>
                    <td>${answer.group_name}</td>
                    <td>
                        <a href="${answer.file_url}" target="_blank" download>
                            ${shortName}
                        </a>
                    </td>
                    <td>${formattedDate}</td>
                    <td>${gradeDisplay}</td>
                    <td>
                        <button class="btn btn-sm btn-primary grade-answer-btn"
                                data-answer-id="${answer.id}"
                                data-bs-toggle="modal"
                                data-bs-target="#gradeAnswerModal">
                            Оценить
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            console.log('No student answers found');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Нет ответов студентов</td></tr>';
        }
    })
    .catch(error => {
        console.error('Error loading student answers:', error);
        if (typeof showToast === 'function') {
            showToast('Ошибка загрузки ответов', 'danger');
        } else {
            console.error('showToast function is not defined');
        }
    });
}





// Инициализация сортировки
function initSortable(chapterId) {
    const materialsList = document.getElementById('materials-list');
    if (materialsList) {
        new Sortable(materialsList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            handle: '.drag-handle',
            onEnd: function() {
                const order = Array.from(materialsList.children).map(item => item.dataset.id);
                saveMaterialsOrder(chapterId, order);
            }
        });
    }
}

// Сохранение порядка материалов
function saveMaterialsOrder(chapterId, order) {
    fetch('/chapter/' + chapterId + '/update_materials_order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({order: order})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showDynamicToast('Порядок сохранён');
        } else {
            showDynamicToast('Ошибка при сохранении порядка', 'danger');
        }
    })
    .catch(error => {
        showDynamicToast('Ошибка при сохранении порядка', 'danger');
        console.error('Ошибка:', error);
    });
}

// Настройка обработчиков событий
function setupEventHandlers() {
        document.getElementById('fileUploadForm')?.addEventListener('submit', handleFileUpload);
    document.getElementById('videoUploadForm')?.addEventListener('submit', handleVideoUpload);
    document.getElementById('linkUploadForm')?.addEventListener('submit', handleLinkUpload);
    document.getElementById('editFileForm')?.addEventListener('submit', handleEditFile);
    document.getElementById('editVideoForm')?.addEventListener('submit', handleEditVideo);
    document.getElementById('editLinkForm')?.addEventListener('submit', handleEditLink);
    // Обработчики кнопок редактирования
    document.querySelectorAll('.edit-file-btn').forEach(btn => {
        btn.addEventListener('click', showEditFileModal);
    });
    document.querySelectorAll('.edit-video-btn').forEach(btn => {
        btn.addEventListener('click', showEditVideoModal);
    });
    document.querySelectorAll('.edit-link-btn').forEach(btn => {
        btn.addEventListener('click', showEditLinkModal);
    });

    // Обработчик кнопки "Изменить" в модальном окне редактирования файла
    document.getElementById('changeFileBtn')?.addEventListener('click', function() {
        document.getElementById('newFileForm').style.display = 'block';
        this.style.display = 'none';
    });
}

// Функции для работы с видео
function openVideoModal(videoUrl) {
    const modal = document.getElementById('videoModal');
    const videoContainer = document.getElementById('videoContainer');

    if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
        let videoId = videoUrl.split('v=')[1];
        if (!videoId) videoId = videoUrl.split('youtu.be/')[1];
        if (videoId) videoId = videoId.split('&')[0];

        videoContainer.innerHTML = `
            <iframe width="100%" height="700"
                src="https://www.youtube.com/embed/${videoId}"
                frameborder="0"
                allowfullscreen>
            </iframe>`;
    } else {
        videoContainer.innerHTML = `
            <video width="100%" height="700" controls>
                <source src="${videoUrl}" type="video/mp4">
                Ваш браузер не поддерживает видео.
            </video>`;
    }

    modal.style.display = "block";
}

function closeVideoModal() {
    document.getElementById('videoModal').style.display = "none";
    document.getElementById('videoContainer').innerHTML = '';
}

window.onclick = function(event) {
    const modal = document.getElementById('videoModal');
    if (event.target == modal) {
        closeVideoModal();
    }
}

// Редактирование файла
function showEditFileModal() {
    const fileId = this.dataset.id;
    fetch(`/chapter/file/${fileId}/get/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('editFileId').value = fileId;
        document.getElementById('editFileName').value = data.display_name;

        const currentFileLink = document.getElementById('currentFileLink');
        const currentFileName = document.getElementById('currentFileName');
        const newFileForm = document.getElementById('newFileForm');

        if (data.file_url) {
            currentFileLink.href = data.file_url;
            currentFileName.textContent = data.file_name || 'Файл';
            currentFileLink.style.display = 'inline-block';
            newFileForm.style.display = 'none';
            document.getElementById('changeFileBtn').style.display = 'inline-block';
        } else {
            currentFileLink.style.display = 'none';
            currentFileName.textContent = 'Файл не загружен';
            newFileForm.style.display = 'block';
            document.getElementById('changeFileBtn').style.display = 'none';
        }

        new bootstrap.Modal(document.getElementById('editFileModal')).show();
    });
}

// Редактирование видео
function showEditVideoModal() {
    const videoId = this.dataset.id;
    fetch(`/chapter/video/${videoId}/get/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('editVideoId').value = videoId;
        document.getElementById('editVideoTitle').value = data.title;
        document.getElementById('editVideoUrl').value = data.video_url || '';
        new bootstrap.Modal(document.getElementById('editVideoModal')).show();
    });
}

// Редактирование ссылки
function showEditLinkModal() {
    const linkId = this.dataset.id;
    fetch(`/chapter/link/${linkId}/get/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('editLinkId').value = linkId;
        document.getElementById('editLinkTitle').value = data.title;
        document.getElementById('editLinkUrl').value = data.url;
        new bootstrap.Modal(document.getElementById('editLinkModal')).show();
    });
}
</script>

{% endblock %}